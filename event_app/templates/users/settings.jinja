{% extends "global.jinja" %}

{% block title %}Vent | Settings{% endblock %}

{% block stylesheets %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users/settings.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script type="text/javascript">
        var map;
        var marker;

        L.Control.UpdateLocation = L.Control.extend({
            onAdd: function (map) {
                var button = L.DomUtil.create('button', 'update-button');
                button.innerHTML = "Update Location";

                L.DomEvent.on(button, 'click', function (e) {
                    var loc = marker.getLatLng();
                    $.ajax({
                        method: "POST",
                        url: "{{ url_for("ajax.update_location") }}",
                        data: {
                            lat: loc.lat,
                            lng: loc.lng
                        },
                        success: function (data) {
                            toastr['success']("Location Updated");
                        },
                        error: function (data) {
                            toastr['error']("Something went wrong! Try again later.");
                        }
                    });
                    L.DomEvent.stopPropagation(e);
                });

                return button
            },

            onRemove: function (map) {
                L.DomEvent.off(this, 'click');
            }
        });

        $(document).ready(function () {
            map = L.map('userLocation');
            {%- if current_user.location_enabled -%}
                map.setView([{{ current_user.latitude }}, {{ current_user.longitude }}], 10);
                placeMarker([{{ current_user.latitude }}, {{ current_user.longitude }}]);
            {%- else -%}
                map.locate({setView: true});
            {%- endif -%}
            map.on('locationfound', eventHandler);
            map.on('click', eventHandler);

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>, Marker Icon made by <a href="https://www.flaticon.com/authors/simpleicon" title="SimpleIcon">SimpleIcon</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>',
                maxZoom: 18,
                minZoom: 2,
                id: 'mapbox.streets',
                accessToken: "{{ config['MAPBOX_ACCESS_TOKEN'] }}"
            }).addTo(map);

            var updateLocation = new L.Control.UpdateLocation({
                position: "topright"
            });
            updateLocation.addTo(map);
        });

        function placeMarker(pos) {
            if (marker === undefined) {
                marker = L.marker(pos, {
                    icon: L.icon({
                        iconUrl: '{{ url_for('static', filename="img/users/map-marker.svg") }}',
                        iconSize: [50, 50],
                        iconAnchor: [25, 50],
                    }),
                    draggable: true
                });
                marker.addTo(map);
            } else {
                marker.setLatLng(pos);
            }
        }

        function eventHandler(e) {
            placeMarker(e.latlng);
        }
    </script>


{% endblock %}

{% block nav_items %}
    <li class="navigation-item">
        <a class="navigation-link" href="{{ url_for('home.index') }}">Dashboard</a>
    </li>
    <li class="navigation-item">
        <a class="navigation-link" href="{{ url_for('events.discover') }}">Discover</a>
    </li>
    <li class="navigation-item">
        <a class="navigation-link" href="{{ url_for('users.settings') }}">Settings</a>
    </li>
    <li class="navigation-item">
        <a class="navigation-link" href="#" onclick="$('#logout-form').submit();">Logout</a>
    </li>
{% endblock %}

{% block content %}
    <div id="userLocation"></div>
{% endblock %}